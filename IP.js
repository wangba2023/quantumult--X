/* Modified from DoingDog 
-----------------------------------------------------------------------  */


// è‡ªç”¨qxæ ‡é¢˜æ˜¾ç¤ºè„šæœ¬ï¼Œä»ŽKOP-XIAOä¿®æ”¹

// usage:  geo_location_checker=http://ip-api.com/json/?fields=21753855&lang=zh-CN, https://raw.githubusercontent.com/Tru-tru/QuantumultX/main/Geo-location-checker/Tru-IP-Sample2.js

// original Shawn's:  https://raw.githubusercontent.com/KOP-XIAO/QuantumultX/master/Scripts/IP_API.js

// full version with IP and "display ISP" in subtitle

if ($response.statusCode !== 200) {
  $done(null);
}

const citytest = /[a-zA-Z]+[a-zA-Z]+/;

function letterCheck(para, paraa, paraaa) {
  if (citytest.test(para) || para.length < 2) {
    if (citytest.test(paraa) || paraa.length < 2) {
      return paraaa;
    }
    return paraa;
  }
  return para;
}

function placeAdder(para) {
  if (para) {
    if (citytest.test(para)) {
      return '';
    }
    return ` ${para}`;
  }
  return '';
}

function geticon(para, paraa) {
  if (para === true) {
    return `${paraa} `;
  }
  return '';
}

const flags = new Map([
  ['AC', 'ðŸ‡¦ðŸ‡¨'],
  ['AD', 'ðŸ‡¦ðŸ‡©'],
  ['AE', 'ðŸ‡¦ðŸ‡ª'],
  ['AF', 'ðŸ‡¦ðŸ‡«'],
  ['AG', 'ðŸ‡¦ðŸ‡¬'],
  ['AI', 'ðŸ‡¦ðŸ‡®'],
  ['AL', 'ðŸ‡¦ðŸ‡±'],
  ['AM', 'ðŸ‡¦ðŸ‡²'],
  ['AO', 'ðŸ‡¦ðŸ‡´'],
  ['AQ', 'ðŸ‡¦ðŸ‡¶'],
  ['AR', 'ðŸ‡¦ðŸ‡·'],
  ['AS', 'ðŸ‡¦ðŸ‡¸'],
  ['AT', 'ðŸ‡¦ðŸ‡¹'],
  ['AU', 'ðŸ‡¦ðŸ‡º'],
  ['AW', 'ðŸ‡¦ðŸ‡¼'],
  ['AX', 'ðŸ‡¦ðŸ‡½'],
  ['AZ', 'ðŸ‡¦ðŸ‡¿'],
  ['BA', 'ðŸ‡§ðŸ‡¦'],
  ['BB', 'ðŸ‡§ðŸ‡§'],
  ['BD', 'ðŸ‡§ðŸ‡©'],
  ['BE', 'ðŸ‡§ðŸ‡ª'],
  ['BF', 'ðŸ‡§ðŸ‡«'],
  ['BG', 'ðŸ‡§ðŸ‡¬'],
  ['BH', 'ðŸ‡§ðŸ‡­'],
  ['BI', 'ðŸ‡§ðŸ‡®'],
  ['BJ', 'ðŸ‡§ðŸ‡¯'],
  ['BM', 'ðŸ‡§ðŸ‡²'],
  ['BN', 'ðŸ‡§ðŸ‡³'],
  ['BO', 'ðŸ‡§ðŸ‡´'],
  ['BR', 'ðŸ‡§ðŸ‡·'],
  ['BS', 'ðŸ‡§ðŸ‡¸'],
  ['BT', 'ðŸ‡§ðŸ‡¹'],
  ['BV', 'ðŸ‡§ðŸ‡»'],
  ['BW', 'ðŸ‡§ðŸ‡¼'],
  ['BY', 'ðŸ‡§ðŸ‡¾'],
  ['BZ', 'ðŸ‡§ðŸ‡¿'],
  ['CA', 'ðŸ‡¨ðŸ‡¦'],
  ['CD', 'ðŸ‡¨ðŸ‡©'],
  ['CF', 'ðŸ‡¨ðŸ‡«'],
  ['CG', 'ðŸ‡¨ðŸ‡¬'],
  ['CH', 'ðŸ‡¨ðŸ‡­'],
  ['CI', 'ðŸ‡¨ðŸ‡®'],
  ['CK', 'ðŸ‡¨ðŸ‡°'],
  ['CL', 'ðŸ‡¨ðŸ‡±'],
  ['CM', 'ðŸ‡¨ðŸ‡²'],
  ['CN', 'ðŸ‡¨ðŸ‡³'],
  ['CO', 'ðŸ‡¨ðŸ‡´'],
  ['CP', 'ðŸ‡¨ðŸ‡µ'],
  ['CR', 'ðŸ‡¨ðŸ‡·'],
  ['CU', 'ðŸ‡¨ðŸ‡º'],
  ['CV', 'ðŸ‡¨ðŸ‡»'],
  ['CW', 'ðŸ‡¨ðŸ‡¼'],
  ['CX', 'ðŸ‡¨ðŸ‡½'],
  ['CY', 'ðŸ‡¨ðŸ‡¾'],
  ['CZ', 'ðŸ‡¨ðŸ‡¿'],
  ['DE', 'ðŸ‡©ðŸ‡ª'],
  ['DG', 'ðŸ‡©ðŸ‡¬'],
  ['DJ', 'ðŸ‡©ðŸ‡¯'],
  ['DK', 'ðŸ‡©ðŸ‡°'],
  ['DM', 'ðŸ‡©ðŸ‡²'],
  ['DO', 'ðŸ‡©ðŸ‡´'],
  ['DZ', 'ðŸ‡©ðŸ‡¿'],
  ['EA', 'ðŸ‡ªðŸ‡¦'],
  ['EC', 'ðŸ‡ªðŸ‡¨'],
  ['EE', 'ðŸ‡ªðŸ‡ª'],
  ['EG', 'ðŸ‡ªðŸ‡¬'],
  ['EH', 'ðŸ‡ªðŸ‡­'],
  ['ER', 'ðŸ‡ªðŸ‡·'],
  ['ES', 'ðŸ‡ªðŸ‡¸'],
  ['ET', 'ðŸ‡ªðŸ‡¹'],
  ['EU', 'ðŸ‡ªðŸ‡º'],
  ['FI', 'ðŸ‡«ðŸ‡®'],
  ['FJ', 'ðŸ‡«ðŸ‡¯'],
  ['FK', 'ðŸ‡«ðŸ‡°'],
  ['FM', 'ðŸ‡«ðŸ‡²'],
  ['FO', 'ðŸ‡«ðŸ‡´'],
  ['FR', 'ðŸ‡«ðŸ‡·'],
  ['GA', 'ðŸ‡¬ðŸ‡¦'],
  ['GB', 'ðŸ‡¬ðŸ‡§'],
  ['GD', 'ðŸ‡¬ðŸ‡©'],
  ['GE', 'ðŸ‡¬ðŸ‡ª'],
  ['GF', 'ðŸ‡¬ðŸ‡«'],
  ['GH', 'ðŸ‡¬ðŸ‡­'],
  ['GI', 'ðŸ‡¬ðŸ‡®'],
  ['GL', 'ðŸ‡¬ðŸ‡±'],
  ['GM', 'ðŸ‡¬ðŸ‡²'],
  ['GN', 'ðŸ‡¬ðŸ‡³'],
  ['GP', 'ðŸ‡¬ðŸ‡µ'],
  ['GR', 'ðŸ‡¬ðŸ‡·'],
  ['GT', 'ðŸ‡¬ðŸ‡¹'],
  ['GU', 'ðŸ‡¬ðŸ‡º'],
  ['GW', 'ðŸ‡¬ðŸ‡¼'],
  ['GY', 'ðŸ‡¬ðŸ‡¾'],
  ['HK', 'ðŸ‡­ðŸ‡°'],
  ['HN', 'ðŸ‡­ðŸ‡³'],
  ['HR', 'ðŸ‡­ðŸ‡·'],
  ['HT', 'ðŸ‡­ðŸ‡¹'],
  ['HU', 'ðŸ‡­ðŸ‡º'],
  ['ID', 'ðŸ‡®ðŸ‡©'],
  ['IE', 'ðŸ‡®ðŸ‡ª'],
  ['IL', 'ðŸ‡®ðŸ‡±'],
  ['IM', 'ðŸ‡®ðŸ‡²'],
  ['IN', 'ðŸ‡®ðŸ‡³'],
  ['IR', 'ðŸ‡®ðŸ‡·'],
  ['IS', 'ðŸ‡®ðŸ‡¸'],
  ['IT', 'ðŸ‡®ðŸ‡¹'],
  ['JM', 'ðŸ‡¯ðŸ‡²'],
  ['JO', 'ðŸ‡¯ðŸ‡´'],
  ['JP', 'ðŸ‡¯ðŸ‡µ'],
  ['KE', 'ðŸ‡°ðŸ‡ª'],
  ['KG', 'ðŸ‡°ðŸ‡¬'],
  ['KH', 'ðŸ‡°ðŸ‡­'],
  ['KI', 'ðŸ‡°ðŸ‡®'],
  ['KM', 'ðŸ‡°ðŸ‡²'],
  ['KN', 'ðŸ‡°ðŸ‡³'],
  ['KP', 'ðŸ‡°ðŸ‡µ'],
  ['KR', 'ðŸ‡°ðŸ‡·'],
  ['KW', 'ðŸ‡°ðŸ‡¼'],
  ['KY', 'ðŸ‡°ðŸ‡¾'],
  ['KZ', 'ðŸ‡°ðŸ‡¿'],
  ['LA', 'ðŸ‡±ðŸ‡¦'],
  ['LB', 'ðŸ‡±ðŸ‡§'],
  ['LC', 'ðŸ‡±ðŸ‡¨'],
  ['LI', 'ðŸ‡±ðŸ‡®'],
  ['LK', 'ðŸ‡±ðŸ‡°'],
  ['LR', 'ðŸ‡±ðŸ‡·'],
  ['LS', 'ðŸ‡±ðŸ‡¸'],
  ['LT', 'ðŸ‡±ðŸ‡¹'],
  ['LU', 'ðŸ‡±ðŸ‡º'],
  ['LV', 'ðŸ‡±ðŸ‡»'],
  ['LY', 'ðŸ‡±ðŸ‡¾'],
  ['MA', 'ðŸ‡²ðŸ‡¦'],
  ['MC', 'ðŸ‡²ðŸ‡¨'],
  ['MD', 'ðŸ‡²ðŸ‡©'],
  ['MG', 'ðŸ‡²ðŸ‡¬'],
  ['MH', 'ðŸ‡²ðŸ‡­'],
  ['MK', 'ðŸ‡²ðŸ‡°'],
  ['ML', 'ðŸ‡²ðŸ‡±'],
  ['MM', 'ðŸ‡²ðŸ‡²'],
  ['MN', 'ðŸ‡²ðŸ‡³'],
  ['MO', 'ðŸ‡²ðŸ‡´'],
  ['MP', 'ðŸ‡²ðŸ‡µ'],
  ['MQ', 'ðŸ‡²ðŸ‡¶'],
  ['MR', 'ðŸ‡²ðŸ‡·'],
  ['MS', 'ðŸ‡²ðŸ‡¸'],
  ['MT', 'ðŸ‡²ðŸ‡¹'],
  ['MU', 'ðŸ‡²ðŸ‡º'],
  ['MV', 'ðŸ‡²ðŸ‡»'],
  ['MW', 'ðŸ‡²ðŸ‡¼'],
  ['MX', 'ðŸ‡²ðŸ‡½'],
  ['MY', 'ðŸ‡²ðŸ‡¾'],
  ['MZ', 'ðŸ‡²ðŸ‡¿'],
  ['NA', 'ðŸ‡³ðŸ‡¦'],
  ['NC', 'ðŸ‡³ðŸ‡¨'],
  ['NE', 'ðŸ‡³ðŸ‡ª'],
  ['NF', 'ðŸ‡³ðŸ‡«'],
  ['NG', 'ðŸ‡³ðŸ‡¬'],
  ['NI', 'ðŸ‡³ðŸ‡®'],
  ['NL', 'ðŸ‡³ðŸ‡±'],
  ['NO', 'ðŸ‡³ðŸ‡´'],
  ['NP', 'ðŸ‡³ðŸ‡µ'],
  ['NR', 'ðŸ‡³ðŸ‡·'],
  ['NZ', 'ðŸ‡³ðŸ‡¿'],
  ['OM', 'ðŸ‡´ðŸ‡²'],
  ['PA', 'ðŸ‡µðŸ‡¦'],
  ['PE', 'ðŸ‡µðŸ‡ª'],
  ['PF', 'ðŸ‡µðŸ‡«'],
  ['PG', 'ðŸ‡µðŸ‡¬'],
  ['PH', 'ðŸ‡µðŸ‡­'],
  ['PK', 'ðŸ‡µðŸ‡°'],
  ['PL', 'ðŸ‡µðŸ‡±'],
  ['PM', 'ðŸ‡µðŸ‡²'],
  ['PR', 'ðŸ‡µðŸ‡·'],
  ['PS', 'ðŸ‡µðŸ‡¸'],
  ['PT', 'ðŸ‡µðŸ‡¹'],
  ['PW', 'ðŸ‡µðŸ‡¼'],
  ['PY', 'ðŸ‡µðŸ‡¾'],
  ['QA', 'ðŸ‡¶ðŸ‡¦'],
  ['RE', 'ðŸ‡·ðŸ‡ª'],
  ['RO', 'ðŸ‡·ðŸ‡´'],
  ['RS', 'ðŸ‡·ðŸ‡¸'],
  ['RU', 'ðŸ‡·ðŸ‡º'],
  ['RW', 'ðŸ‡·ðŸ‡¼'],
  ['SA', 'ðŸ‡¸ðŸ‡¦'],
  ['SB', 'ðŸ‡¸ðŸ‡§'],
  ['SC', 'ðŸ‡¸ðŸ‡¨'],
  ['SD', 'ðŸ‡¸ðŸ‡©'],
  ['SE', 'ðŸ‡¸ðŸ‡ª'],
  ['SG', 'ðŸ‡¸ðŸ‡¬'],
  ['SI', 'ðŸ‡¸ðŸ‡®'],
  ['SK', 'ðŸ‡¸ðŸ‡°'],
  ['SL', 'ðŸ‡¸ðŸ‡±'],
  ['SM', 'ðŸ‡¸ðŸ‡²'],
  ['SN', 'ðŸ‡¸ðŸ‡³'],
  ['SR', 'ðŸ‡¸ðŸ‡·'],
  ['ST', 'ðŸ‡¸ðŸ‡¹'],
  ['SV', 'ðŸ‡¸ðŸ‡»'],
  ['SY', 'ðŸ‡¸ðŸ‡¾'],
  ['SZ', 'ðŸ‡¸ðŸ‡¿'],
  ['TC', 'ðŸ‡¹ðŸ‡¨'],
  ['TD', 'ðŸ‡¹ðŸ‡©'],
  ['TG', 'ðŸ‡¹ðŸ‡¬'],
  ['TH', 'ðŸ‡¹ðŸ‡­'],
  ['TJ', 'ðŸ‡¹ðŸ‡¯'],
  ['TL', 'ðŸ‡¹ðŸ‡±'],
  ['TM', 'ðŸ‡¹ðŸ‡²'],
  ['TN', 'ðŸ‡¹ðŸ‡³'],
  ['TO', 'ðŸ‡¹ðŸ‡´'],
  ['TR', 'ðŸ‡¹ðŸ‡·'],
  ['TT', 'ðŸ‡¹ðŸ‡¹'],
  ['TV', 'ðŸ‡¹ðŸ‡»'],
  ['TW', 'ðŸ‡¨ðŸ‡³'],
  ['TZ', 'ðŸ‡¹ðŸ‡¿'],
  ['UA', 'ðŸ‡ºðŸ‡¦'],
  ['UG', 'ðŸ‡ºðŸ‡¬'],
  ['UK', 'ðŸ‡¬ðŸ‡§'],
  ['UM', 'ðŸ‡ºðŸ‡²'],
  ['US', 'ðŸ‡ºðŸ‡¸'],
  ['UY', 'ðŸ‡ºðŸ‡¾'],
  ['UZ', 'ðŸ‡ºðŸ‡¿'],
  ['VA', 'ðŸ‡»ðŸ‡¦'],
  ['VC', 'ðŸ‡»ðŸ‡¨'],
  ['VE', 'ðŸ‡»ðŸ‡ª'],
  ['VG', 'ðŸ‡»ðŸ‡¬'],
  ['VI', 'ðŸ‡»ðŸ‡®'],
  ['VN', 'ðŸ‡»ðŸ‡³'],
  ['VU', 'ðŸ‡»ðŸ‡º'],
  ['WS', 'ðŸ‡¼ðŸ‡¸'],
  ['YE', 'ðŸ‡¾ðŸ‡ª'],
  ['YT', 'ðŸ‡¾ðŸ‡¹'],
  ['ZA', 'ðŸ‡¿ðŸ‡¦'],
  ['ZM', 'ðŸ‡¿ðŸ‡²'],
  ['ZW', 'ðŸ‡¿ðŸ‡¼'],
]);

const { body } = $response;
const obj = JSON.parse(body);
const title = `${flags.get(obj.countryCode)} ${letterCheck(obj.city, obj.regionName, obj.country)}`;
const subtitle = `${geticon(obj.proxy, 'âš ï¸Ž') + geticon(obj.hosting, 'ðŸ…—') + obj.isp}  âž¤ ${placeAdder(obj.country)}${placeAdder(obj.regionName)}${placeAdder(obj.city)}${placeAdder(obj.district)}  âž¤  ${obj.query}`;
const ip = obj.query;
const description = `${'\n' + 'ä½ç½® ['}${placeAdder(obj.country)}${placeAdder(obj.regionName)}${placeAdder(obj.city)}${placeAdder(obj.district)}]\n\n` + `IP [${obj.query}]\n\n` + `ISP [${obj.isp}]\n\n` + `ORG [${obj.org}]\n\n` + `ASN [${obj.as.replace(/ .*$/gi, '')}]\n\n` + `ASNåç§° [${obj.asname}]\n\n` + `æ—¶åŒº [${obj.timezone}]\n\n` + `é‚®ç¼– [${obj.zip}]\n\n` + 'å®šä½ [' + ` çº¬åº¦ ${obj.lat},` + `ç»åº¦ ${obj.lon} ]\n\n` + `ç‰¹æ®Šä¿¡æ¯ [${geticon(obj.mobile, 'ç§»åŠ¨')}${geticon(obj.hosting, 'æ‰˜ç®¡')}${geticon(obj.proxy, 'ä»£ç†')}]`;

$done({
  title,
  subtitle,
  ip,
  description,
});
